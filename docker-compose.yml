services:
  ros2_humble:
    build:
      context: ./ros2_humble
    container_name: experimental_robotics_humble
    hostname: ros2-humble
    networks: [rosnet]
    environment:
      RMW_IMPLEMENTATION: rmw_fastrtps_cpp
      ROS_DOMAIN_ID: ${ROS_DOMAIN_ID:-43}
      DISPLAY: ${DISPLAY:-:0}
      QT_X11_NO_MITSHM: "1"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: all
      ROS_DISTRO: humble
      # Graphics/Gazebo environment (configured dynamically in container)
      XDG_RUNTIME_DIR: /tmp/runtime-dir
    volumes:
      # X11 forwarding for GUI applications
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # ROS2 workspace mounting
      - ./ros2_humble_ws:/root/ros2_ws:rw
      # Config files
      - ./config:/root/config:ro
      # Scripts
      - ./scripts:/root/scripts:ro
    shm_size: "2gb"
    devices:
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    privileged: true
    restart: unless-stopped
    profiles: ["humble", "all"]
    stdin_open: true
    tty: true
    command: bash -c "source /opt/ros/humble/setup.bash && /root/scripts/entrypoint_humble.sh && tail -f /dev/null"

  ros2_jazzy:
    build:
      context: ./ros2_jazzy
    container_name: experimental_robotics_jazzy
    hostname: ros2-jazzy
    networks: [rosnet]
    environment:
      RMW_IMPLEMENTATION: rmw_fastrtps_cpp
      ROS_DOMAIN_ID: ${ROS_DOMAIN_ID:-43}
      DISPLAY: ${DISPLAY:-:0}
      QT_X11_NO_MITSHM: "1"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: all
      ROS_DISTRO: jazzy
      # Graphics/Gazebo environment (configured dynamically in container)
      XDG_RUNTIME_DIR: /tmp/runtime-dir
    volumes:
      # X11 forwarding for GUI applications
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # ROS2 workspace mounting
      - ./ros2_jazzy_ws:/root/ros2_ws:rw
      # Config files
      - ./config:/root/config:ro
      # Scripts
      - ./scripts:/root/scripts:ro
    shm_size: "2gb"
    devices:
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    privileged: true
    restart: unless-stopped
    profiles: ["jazzy", "all"]
    stdin_open: true
    tty: true
    command: bash -c "source /opt/ros/jazzy/setup.bash && /root/scripts/entrypoint_jazzy.sh && tail -f /dev/null"

networks:
  rosnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16