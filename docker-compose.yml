services:
  ros2_humble:
    build:
      context: ./ros2_humble
    container_name: experimental_robotics_humble
    hostname: ros2-humble
    networks: [rosnet]
    environment:
      RMW_IMPLEMENTATION: rmw_cyclonedx_cpp
      ROS_DOMAIN_ID: ${ROS_DOMAIN_ID:-42}
      DISPLAY: ${DISPLAY:-:0}
      QT_X11_NO_MITSHM: "1"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: all
      ROS_DISTRO: humble
    volumes:
      # X11 forwarding for GUI applications
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # ROS2 workspace mounting
      - ./ros2_humble_ws:/root/ros2_ws:rw
      # Config files
      - ./config:/root/config:ro
      # Scripts
      - ./scripts:/root/scripts:ro
    shm_size: "2gb"
    devices:
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    privileged: true
    restart: unless-stopped
    profiles: ["humble", "all"]
    stdin_open: true
    tty: true
    command: bash -c "source /opt/ros/humble/setup.bash && /root/scripts/entrypoint_humble.sh"

  ros2_jazzy:
    build:
      context: ./ros2_jazzy
    container_name: experimental_robotics_jazzy
    hostname: ros2-jazzy
    networks: [rosnet]
    environment:
      RMW_IMPLEMENTATION: rmw_cyclonedx_cpp
      ROS_DOMAIN_ID: ${ROS_DOMAIN_ID:-43}
      DISPLAY: ${DISPLAY:-:0}
      QT_X11_NO_MITSHM: "1"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: all
      ROS_DISTRO: jazzy
    volumes:
      # X11 forwarding for GUI applications
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # ROS2 workspace mounting
      - ./ros2_jazzy_ws:/root/ros2_ws:rw
      # Config files
      - ./config:/root/config:ro
      # Scripts
      - ./scripts:/root/scripts:ro
    shm_size: "2gb"
    devices:
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    privileged: true
    restart: unless-stopped
    profiles: ["jazzy", "all"]
    stdin_open: true
    tty: true
    command: bash -c "source /opt/ros/jazzy/setup.bash && /root/scripts/entrypoint_jazzy.sh"

  # ROS2 Development Environment (Humble-based with additional dev tools)
  ros2_dev:
    build:
      context: ./ros2_humble
      dockerfile: Dockerfile.dev
    container_name: experimental_robotics_dev
    hostname: ros2-dev
    networks: [rosnet]
    environment:
      RMW_IMPLEMENTATION: rmw_cyclonedx_cpp
      ROS_DOMAIN_ID: ${ROS_DOMAIN_ID:-43}
      DISPLAY: ${DISPLAY:-:0}
      QT_X11_NO_MITSHM: "1"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: all
      ROS_DISTRO: humble
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ./ros2_humble_ws:/root/ros2_ws:rw
      - ./ros2_jazzy_ws:/root/ros2_jazzy_ws:rw
      - ./config:/root/config:ro
      - ./scripts:/root/scripts:ro
      # Mount host's .ssh for git access (optional)
      - ~/.ssh:/root/.ssh:ro
      # Mount host's .gitconfig (optional)
      - ~/.gitconfig:/root/.gitconfig:ro
    shm_size: "4gb"
    devices:
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    privileged: true
    restart: unless-stopped
    profiles: ["dev"]
    stdin_open: true
    tty: true
    command: bash -c "source /opt/ros/humble/setup.bash && /root/scripts/entrypoint_dev.sh"

networks:
  rosnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16